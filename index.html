<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HKMC Barcode Reader V1</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="manifest" href="manifest.json">

<style>
  body{font-family:'Segoe UI', Tahoma, Verdana, sans-serif;background:#f8f8f8;margin:20px;}
  header{display:flex;align-items:center;margin-bottom:20px;}
  header img{width:40px;height:40px;margin-right:10px;}
  h2{margin:0;font-size:1.5em;color:#333;}
  .creator{font-size:0.4em;font-weight:bold;color:gray;margin-top:2px;}
  button{padding:10px 15px;border:none;border-radius:5px;background:#fff;color:#333;cursor:pointer;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);margin-right:5px;transition:all .15s ease;}
  button:hover{background:#f0f0f0;}
  #err{color:red;font-weight:bold;margin-top:10px;}
  table{border-collapse:collapse;width:100%;margin-top:20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  td,th{border:1px solid #e0e0e0;padding:8px;text-align:left;}
  th{background:#f4f4f4;width:40%;}
  .missing{color:red;font-weight:bold;}
  #video{width:100%;margin-top:10px;display:none;border-radius:8px;background:#000;}
</style>
</head>
<body>

<header>
  <img src="https://upload.wikimedia.org/wikipedia/commons/c/c2/Harman_International_logo.svg" alt="Harman Logo">
  <div>
    <h2>HKMC Barcode Reader V1</h2>
    <div class="creator">Creator @pboldog</div>
  </div>
</header>

<button id="startBtn">Kamera indítása</button>
<button id="stopBtn" style="display:none">Kamera leállítása</button>

<div id="err"></div>
<div id="out"></div>
<video id="video" autoplay muted></video>

<!-- ZXing -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>

<script>
/* ---------- helper: show missing styling ---------- */
function fmtVal(v){
  return v === '[nincs]' ? `<span class="missing">${v}</span>` : v;
}

/* ---------- parsing logic ---------- */
function HKMC_Barcode_Content(code){
  if(!code) return "HIBA";

  // EOT eltávolítása
  code = code.replace(/\x04/g,'');

  // fields by RS/GS delimiters (if present)
  const fields = code.split(/[\x1E\x1D]/).filter(f=>f.length>0);

  // initialize as missing
  const result = {
    "Header":"[nincs]",
    "Vendor Code - Marker":"[nincs]",
    "Vendor Code":"[nincs]",
    "HMC Part Number - Marker":"[nincs]",
    "HMC Part Number":"[nincs]",
    "Sequence Code - Marker":"[nincs]",
    "Sequence Code":"[nincs]",
    "Traceability Code - Marker":"[nincs]",
    "Traceability Code - Date (YYMMDD)":"[nincs]",
    "Traceability Code - Plant Info":"[nincs]",
    "Traceability Code Harman P/N Marker":"[nincs]",
    "Traceability Code Harman P/N":"[nincs]",
    "Supplier's Area - Marker":"[nincs]",
    "Supplier's Area":"[nincs]"
  };

  // --- Header: tolerate RS/GS between '>' and '0' ---
  // pattern: [)> (maybe RS/GS) 06
  const headerRegex = /\[\)>(?:[\x1E\x1D])*06/;
  if(headerRegex.test(code)) result["Header"] = "[)>06";

  // Helper: find field in delimiter-split array starting with letter
  const findField = (letter) => {
    return fields.find(f => f.startsWith(letter));
  };

  // --- Vendor (V) ---
  const vField = findField('V');
  const vIndex = code.indexOf('V');
  if(vField){
    result["Vendor Code - Marker"] = 'V';
    result["Vendor Code"] = vField.slice(1) || '[nincs]';
  } else if(vIndex >= 0){
    // fallback: take 4 chars after V if available
    result["Vendor Code - Marker"] = 'V';
    result["Vendor Code"] = code.substring(vIndex+1, vIndex+5) || '[nincs]';
  }

  // --- HMC Part Number: P marker and S marker boundary (10 chars) ---
  const pIndex = code.indexOf('P');
  const sIndex = code.indexOf('S');
  if(pIndex >= 0){
    result["HMC Part Number - Marker"] = 'P';
    // if S exists after P, use exactly 10 chars after P
    if(sIndex > pIndex){
      result["HMC Part Number"] = code.substring(pIndex+1, pIndex+11) || '[nincs]';
    } else {
      // no S found after P: try to extract 10 chars after P (if present)
      result["HMC Part Number"] = code.substring(pIndex+1, pIndex+11) || '[nincs]';
    }
  }

  // --- Sequence (between S and T). S marker must be present (per your rule)
  const sPos = code.indexOf('S');
  const tPos = code.indexOf('T');
  if(sPos >= 0){
    result["Sequence Code - Marker"] = 'S';
    if(tPos > sPos){
      // substring between S and T; remove possible RS/GS inside
      let seq = code.substring(sPos+1, tPos).replace(/[\x1E\x1D]/g,'');
      result["Sequence Code"] = seq.length ? seq : '[nincs]';
    } else {
      // S present but no T after? treat as missing content
      result["Sequence Code"] = '[nincs]';
    }
  } else {
    // If S absent, mark both as missing (but per latest you said S always present)
    result["Sequence Code - Marker"] = '[nincs]';
    result["Sequence Code"] = '[nincs]';
  }

  // --- Traceability T ---
  // get tField either from delimiter fields or substring from tPos to next marker (C) or end
  if(tPos >= 0){
    result["Traceability Code - Marker"] = 'T';
    // Try fields first:
    let tField = findField('T');
    if(!tField){
      // build from code: from T to next 'C' (supplier) or end
      let nextC = code.indexOf('C', tPos+1);
      tField = nextC>tPos ? code.substring(tPos, nextC) : code.substring(tPos);
    }
    // remove any delimiters
    tField = tField.replace(/[\x1E\x1D]/g,'');
    // parse: after 'T'
    const tdata = tField.slice(1); // without leading 'T'
    if(tdata.length >= 6) result["Traceability Code - Date (YYMMDD)"] = tdata.slice(0,6);
    if(tdata.length >= 10) result["Traceability Code - Plant Info"] = tdata.slice(6,10);
    const rest = tdata.slice(10) || '';
    if(rest.startsWith('@')){
      result["Traceability Code Harman P/N Marker"] = '@';
      result["Traceability Code Harman P/N"] = rest.slice(1) || '[nincs]';
    } else if(rest.length){
      result["Traceability Code Harman P/N Marker"] = '[nincs]';
      result["Traceability Code Harman P/N"] = rest;
    }
  }

  // --- Supplier C ---
  const cField = findField('C');
  const cPos = code.indexOf('C');
  if(cField){
    result["Supplier's Area - Marker"] = 'C';
    // if there's more characters after C in that field, take up to 3 (as earlier)
    result["Supplier's Area"] = cField.slice(1,4) || '[nincs]';
  } else if(cPos >= 0){
    result["Supplier's Area - Marker"] = 'C';
    result["Supplier's Area"] = code.substring(cPos+1, cPos+4) || '[nincs]';
  }

  return result;
}

/* ---------- UI rendering ---------- */
function renderResult(obj){
  if(obj === "HIBA") {
    document.getElementById('err').innerText = "HIBÁS KÓD!";
    document.getElementById('out').innerHTML = '';
    return;
  }
  document.getElementById('err').innerText = '';

  let html = '<table>';
  // same ordering as VBA
  const keys = [
    "Header",
    "Vendor Code - Marker",
    "Vendor Code",
    "HMC Part Number - Marker",
    "HMC Part Number",
    "Sequence Code - Marker",
    "Sequence Code",
    "Traceability Code - Marker",
    "Traceability Code - Date (YYMMDD)",
    "Traceability Code - Plant Info",
    "Traceability Code Harman P/N Marker",
    "Traceability Code Harman P/N",
    "Supplier's Area - Marker",
    "Supplier's Area"
  ];
  for(const k of keys){
    const v = obj[k] !== undefined ? obj[k] : '[nincs]';
    html += `<tr><th>${k}</th><td>${fmtVal(v)}</td></tr>`;
  }
  html += '</table>';
  document.getElementById('out').innerHTML = html;
}

/* ---------- beep (WebAudio) ---------- */
function beepShort(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 1000;
    o.connect(g);
    g.connect(ctx.destination);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.16);
    setTimeout(()=>{ o.stop(); ctx.close(); }, 200);
  }catch(e){
    // ignore audio errors (autoplay restrictions)
    console.warn('beep fail', e);
  }
}

/* ---------- camera control ---------- */
let codeReader = null;
const videoElem = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');

function resetAll(){
  document.getElementById('out').innerHTML = '';
  document.getElementById('err').innerText = '';
  videoElem.style.display = 'none';
  if(codeReader) {
    try { codeReader.reset(); } catch(e){/*ignore*/ }
  }
  startBtn.style.display = '';
  stopBtn.style.display = 'none';
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);

function stopCamera(){
  if(codeReader){
    try{ codeReader.reset(); }catch(e){}
  }
  videoElem.style.display = 'none';
  startBtn.style.display = '';
  stopBtn.style.display = 'none';
}

/* start camera: clears previous table, shows video, starts decoding */
function startCamera(){
  resetAll(); // clear previous output
  videoElem.style.display = 'block';
  startBtn.style.display = 'none';
  stopBtn.style.display = '';

  if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

  // ask for rear camera
  codeReader.decodeFromVideoDevice(null, videoElem, (result, err) => {
    if(result){
      // got text
      const text = result.text || '';
      const parsed = HKMC_Barcode_Content(text);
      renderResult(parsed);

      // beep + vibrate
      beepShort();
      if(navigator.vibrate) navigator.vibrate(180);

      // stop camera and hide video
      try{ codeReader.reset(); }catch(e){}
      videoElem.style.display = 'none';
      startBtn.style.display = '';
      stopBtn.style.display = 'none';
    }
    // ignore per-frame errors; general errors handled in catch below
  }).catch(e=>{
    document.getElementById('err').innerText = "Kamera hiba: " + (e && e.message ? e.message : e);
    // ensure buttons in proper state
    startBtn.style.display = '';
    stopBtn.style.display = 'none';
    try{ if(codeReader) codeReader.reset(); }catch(e){}
    videoElem.style.display = 'none';
  });
}

</script>
</body>
</html>
