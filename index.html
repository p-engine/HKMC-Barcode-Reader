<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HKMC Barcode Reader V1</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="manifest" href="manifest.json">

<style>
  body{font-family:'Segoe UI', Tahoma, Verdana, sans-serif;background:#f8f8f8;margin:20px;}
  header{display:flex;align-items:center;margin-bottom:20px;}
  header img{width:40px;height:40px;margin-right:10px;}
  h2{margin:0;font-size:1.5em;color:#333;}
  .creator{font-size:0.4em;font-weight:bold;color:gray;margin-top:2px;}
  button{padding:10px 15px;border:none;border-radius:5px;background:#fff;color:#333;cursor:pointer;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);margin-right:5px;transition:all .15s ease;}
  button:hover{background:#f0f0f0;}
  #err{color:red;font-weight:bold;margin-top:10px;}
  table{border-collapse:collapse;width:100%;margin-top:20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  td,th{border:1px solid #e0e0e0;padding:8px;text-align:left;}
  th{background:#f4f4f4;width:40%;}
  .missing{color:red;font-weight:bold;}
  #video{width:100%;margin-top:10px;display:none;border-radius:8px;background:#000;}
</style>
</head>
<body>

<header>
  <img src="https://upload.wikimedia.org/wikipedia/commons/c/c2/Harman_International_logo.svg" alt="Harman Logo">
  <div>
    <h2>HKMC Barcode Reader V1</h2>
    <div class="creator">Creator @pboldog</div>
  </div>
</header>

<button id="startScan">Kamera indítása</button>
<button id="restartScan" style="display:none;">Újra szkennelés</button>
<div id="cameraContainer"></div>

<table id="resultTable" style="display:none;">
<tbody></tbody>
</table>

<script>
let videoStream=null;

function beep(){
    try{
        const ctx=new AudioContext();
        const osc=ctx.createOscillator();
        osc.connect(ctx.destination);
        osc.frequency.value=800;
        osc.start();
        setTimeout(()=>osc.stop(),120);
    }catch(e){}
}

async function startCamera(){
    const container=document.getElementById('cameraContainer');
    container.innerHTML="";
    const video=document.createElement('video');
    container.appendChild(video);

    videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=videoStream;
    await video.play();

    const barcodeDetector=new BarcodeDetector({formats:["code128","qr_code"]});
    const scanLoop=async()=>{
        if(!videoStream) return;
        try{
            const codes=await barcodeDetector.detect(video);
            if(codes.length>0){
                const raw=codes[0].rawValue;
                beep();
                stopCamera();
                handleCode(raw);
                return;
            }
        }catch(e){}
        requestAnimationFrame(scanLoop);
    };
    requestAnimationFrame(scanLoop);
}

function stopCamera(){
    if(videoStream){
        videoStream.getTracks().forEach(t=>t.stop());
        videoStream=null;
    }
    document.getElementById('cameraContainer').innerHTML="";
}

function addRow(title,value){
    const tbody=document.querySelector("#resultTable tbody");
    const tr=document.createElement("tr");
    tr.innerHTML=`<th>${title}</th><td>${value||"[nincs]"}</td>`;
    tbody.appendChild(tr);
}

function handleCode(code){
    // remove control chars
    code=code.replace(/[\x00-\x1F]/g,'');
    console.log("RAW:",code);

    document.querySelector("#resultTable tbody").innerHTML="";
    document.getElementById("resultTable").style.display="table";
    document.getElementById("restartScan").style.display="inline";
    
    const result={};

    //---------------- HEADER -----------------
    result["HEADER"]=code.includes("[)>06")?"[)>06":"[nincs]";

    //---------------- Vendor -----------------
    let vIndex=code.indexOf('V');
    if(vIndex>=0){
        result["Vendor Code Marker"]='V';
        result["Vendor Code"]=code.substring(vIndex+1,vIndex+5)||"[nincs]";
    }else{
        result["Vendor Code"]="[nincs]";
    }

    //---------------- HMC Part Number --------
    let pIndex=code.indexOf('P');
    if(pIndex>=0){
        result["HMC Part Marker"]='P';
        result["HMC Part Number"]=code.substring(pIndex+1,pIndex+11)||"[nincs]";
    }else{
        // fallback → vendor után 10 char
        if(result["Vendor Code"]!=="[nincs]"){
            let pos=code.indexOf(result["Vendor Code"]);
            result["HMC Part Number"]=code.substring(pos+result["Vendor Code"].length, pos+result["Vendor Code"].length+10)||"[nincs]";
        }else{
            result["HMC Part Number"]="[nincs]";
        }
    }

    //---------------- Sequence optional ------
    let sIndex=code.indexOf('S');
    let tIndex=code.indexOf('T');
    if(sIndex>=0){
        result["Sequence Marker"]='S';
        if(tIndex>sIndex){
            result["Sequence Code"]=code.substring(sIndex+1,tIndex).trim()||"[nincs]";
        }else{
            result["Sequence Code"]=code.substring(sIndex+1).trim()||"[nincs]";
        }
    }else{
        result["Sequence Code"]="[nincs]";
    }

    //---------------- Traceability -----------
    if(tIndex>=0){
        result["Traceability Marker"]='T';
        result["Traceability"]=code.substring(tIndex+1,tIndex+15)||"[nincs]";
    }else{
        result["Traceability"]="[nincs]";
    }

    //---------------- Harman PN  ------------
    let atIndex=code.indexOf('@');
    if(atIndex>=0){
        result["Harman Marker"]='@';
        result["Harman PN"]=code.substring(atIndex+1,atIndex+7)||"[nincs]";
    }else{
        result["Harman PN"]="[nincs]";
    }

    //---------------- Supplier ---------------
    let cIndex=code.indexOf('C');
    if(cIndex>=0){
        result["Supplier Marker"]='C';
        result["Supplier Area"]=code.substring(cIndex+1,cIndex+4)||"[nincs]";
    }else{
        result["Supplier Area"]="[nincs]";
    }

    //------- output table --------------------
    for(const k in result){
        addRow(k,result[k]);
    }
}

// Buttons
document.getElementById("startScan").onclick=()=>{
    document.getElementById("resultTable").style.display="none";
    document.getElementById("restartScan").style.display="none";
    startCamera();
};

document.getElementById("restartScan").onclick=()=>{
    document.getElementById("resultTable").style.display="none";
    document.getElementById("restartScan").style.display="none";
    startCamera();
};
</script>

</body>
</html>
