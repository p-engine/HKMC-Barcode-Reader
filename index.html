<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HKMC Barcode Reader V1</title>

<!-- Cache-busting meta -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="manifest" href="manifest.json">

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8f8f8;
    margin: 20px;
}
header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}
header img {
    width: 40px;
    height: 40px;
    margin-right: 10px;
}
h2 {
    margin: 0;
    font-size: 1.5em;
    color: #333;
}
button {
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    background-color: #fff;
    color: #333;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-right: 5px;
    transition: all 0.2s ease;
}
button:hover { background-color: #f0f0f0; }
#err { color: red; font-weight: bold; margin-top: 10px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
td, th { border: 1px solid #e0e0e0; padding: 8px; text-align: left; }
th { background-color: #f4f4f4; }
#video { width: 100%; margin-top: 10px; display: none; border-radius: 8px; }
</style>
</head>

<body>

<header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c2/Harman_International_logo.svg" alt="Harman Logo">
    <div>
        <h2>HKMC Barcode Reader V1</h2>
        <div style="font-size:0.4em; font-weight:bold; color:gray; margin-top:2px;">Creator @pboldog</div>
    </div>
</header>

<button onclick="startCamera()">Kamera indítása</button>

<div id="err"></div>
<div id="out"></div>
<video id="video"></video>

<!-- ZXing UMD -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>

<script>
// ---------------- HKMC Marker-alapú dekódoló ----------------
function HKMC_Barcode_Content(code) {
    if(!code) return "HIBA";

    code = code.replace(/\x04/g,''); // EOT

    let fields = code.split(/[\x1E\x1D]/).filter(f=>f.length>0);

    let result = {
        "Header":"[nincs]",
        "Vendor Code - Marker":"V",
        "Vendor Code":"[nincs]",
        "HMC Part Number - Marker":"P",
        "HMC Part Number":"[nincs]",
        "Sequence Code - Marker":"S",
        "Sequence Code":"[nincs]",
        "Traceability Code - Marker":"T",
        "Traceability Code - Date (YYMMDD)":"[nincs]",
        "Traceability Code - Plant Info":"[nincs]",
        "Traceability Code Harman P/N Marker":"@",
        "Traceability Code Harman P/N":"[nincs]",
        "Supplier's Area - Marker":"C",
        "Supplier's Area":"[nincs]"
    };

    // Header – RS/GS karakterekkel is felismeri
    let headerMatch = code.match(/\[\)>([\x1E\x1D]?)+06/);
    if(headerMatch){
        result["Header"] = "[)>06";
    }

    // V → Vendor
    let vField = fields.find(f => f.startsWith('V'));
    if(vField) result["Vendor Code"] = vField.slice(1);

    // P → Part Number
    let pField = fields.find(f => f.startsWith('P'));
    if(pField) result["HMC Part Number"] = pField.slice(1);

    // S → Sequence (opcionális)
    let sIndex = code.indexOf('S');
    let tIndex = code.indexOf('T');
    if(sIndex>=0 && tIndex>sIndex){
        let seq = code.substring(sIndex+1, tIndex);
        result["Sequence Code"] = seq ? seq : '[nincs]';
    }

    // T → Traceability
    let tField = fields.find(f => f.startsWith('T'));
    if(tField){
        result["Traceability Code - Date (YYMMDD)"] = tField.slice(1,7);
        result["Traceability Code - Plant Info"] = tField.slice(7,11);
        let rest = tField.slice(11);
        if(rest.startsWith('@')){
            result["Traceability Code Harman P/N Marker"] = '@';
            result["Traceability Code Harman P/N"] = rest.slice(1);
        } else {
            result["Traceability Code Harman P/N Marker"] = '[nincs]';
            result["Traceability Code Harman P/N"] = rest;
        }
    }

    // C → Supplier
    let cField = fields.find(f => f.startsWith('C'));
    if(cField){
        result["Supplier's Area - Marker"] = 'C';
        result["Supplier's Area"] = '[nincs]';
    }

    return result;
}

// ---------------- UI ----------------
function decode(barcodeText){
    let r = HKMC_Barcode_Content(barcodeText);
    if(r==="HIBA"){
        document.getElementById("err").innerText="HIBÁS KÓD!";
        document.getElementById("out").innerHTML="";
        return;
    }
    document.getElementById("err").innerText="";

    let html = "<table>";
    for(let k in r){
        let val = r[k] === "[nincs]" ? `<span style="color:red;font-weight:bold">${r[k]}</span>` : r[k];
        html += `<tr><th>${k}</th><td>${val}</td></tr>`;
    }
    html += "</table>";
    document.getElementById("out").innerHTML = html;
}

// ---------------- Reset ----------------
function resetAll(){
    document.getElementById("out").innerHTML = "";
    document.getElementById("err").innerText = "";
    document.getElementById("video").style.display = "none";
    if(codeReader) codeReader.reset();
}

// ---------------- Kamera ----------------
let codeReader;
function startCamera(){
    const videoElem = document.getElementById("video");
    videoElem.style.display="block";

    if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

    const beep = new Audio('beep.mp3'); // rövid csipogás

    codeReader.decodeFromVideoDevice(null, videoElem, (result, err) => {
        if(result){
            decode(result.text);

            // Csipogás és rezgés
            beep.play().catch(()=>{});
            if(navigator.vibrate) navigator.vibrate(200);

            codeReader.reset();
            videoElem.style.display="none";
        }
    }).catch(e=>{
        document.getElementById("err").innerText = "Kamera hiba: " + e;
    });
}
</script>

</body>
</html>
