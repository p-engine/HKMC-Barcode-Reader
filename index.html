<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HKMC Barcode Reader V1</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="manifest" href="manifest.json">

<style>
  body{font-family:'Segoe UI', Tahoma, Verdana, sans-serif;background:#f8f8f8;margin:20px;}
  header{display:flex;align-items:center;margin-bottom:20px;}
  header img{width:40px;height:40px;margin-right:10px;}
  h2{margin:0;font-size:1.5em;color:#333;}
  .creator{font-size:0.4em;font-weight:bold;color:gray;margin-top:2px;}
  button{padding:10px 15px;border:none;border-radius:5px;background:#fff;color:#333;cursor:pointer;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);margin-right:5px;transition:all .15s ease;}
  button:hover{background:#f0f0f0;}
  #err{color:red;font-weight:bold;margin-top:10px;}
  table{border-collapse:collapse;width:100%;margin-top:20px;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  td,th{border:1px solid #e0e0e0;padding:8px;text-align:left;}
  th{background:#f4f4f4;width:40%;}
  .missing{color:red;font-weight:bold;}
  #video{width:100%;margin-top:10px;display:none;border-radius:8px;background:#000;}
</style>
</head>
<body>

<header>
  <img src="https://upload.wikimedia.org/wikipedia/commons/c/c2/Harman_International_logo.svg" alt="Harman Logo">
  <div>
    <h2>HKMC Barcode Reader V1</h2>
    <div class="creator">Creator @pboldog</div>
  </div>
</header>

<button id="startBtn">Kamera indítása</button>
<button id="stopBtn" style="display:none">Kamera leállítása</button>

<div id="err"></div>
<div id="out"></div>
<video id="video" autoplay muted></video>

<!-- ZXing -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>

<script>
function fmtVal(v){
  return v === '[nincs]' ? `<span class="missing">${v}</span>` : v;
}

/* -------------------- PARSER (módosítva) --------------------- */
function HKMC_Barcode_Content(code){
  if(!code) return "HIBA";

  code = code.replace(/\x04/g,'');
  const fields = code.split(/[\x1E\x1D]/).filter(f=>f.length>0);

  const result = {
    "Header":"[nincs]",
    "Vendor Code - Marker":"[nincs]",
    "Vendor Code":"[nincs]",
    "HMC Part Number - Marker":"[nincs]",
    "HMC Part Number":"[nincs]",
    "Sequence Code - Marker":"[nincs]",
    "Sequence Code":"[nincs]",
    "Traceability Code - Marker":"[nincs]",
    "Traceability Code - Date (YYMMDD)":"[nincs]",
    "Traceability Code - Plant Info":"[nincs]",
    "Traceability Code Harman P/N Marker":"[nincs]",
    "Traceability Code Harman P/N":"[nincs]",
    "Supplier's Area - Marker":"[nincs]",
    "Supplier's Area":"[nincs]"
  };

  const headerRegex = /\[\)>(?:[\x1E\x1D])*06/;
  if(headerRegex.test(code)) result["Header"] = "[)>06";

  const findField = (letter) =>
    fields.find(f => f.startsWith(letter));

  /* --- Vendor V --- */
  const vField = findField('V');
  const vPos = code.indexOf('V');
  if(vField){
    result["Vendor Code - Marker"] = 'V';
    result["Vendor Code"] = vField.slice(1) || '[nincs]';
  } else if(vPos>=0){
    result["Vendor Code - Marker"]='V';
    result["Vendor Code"]=code.substring(vPos+1,vPos+5)||"[nincs]";
  }

  /* --- HMC Part P OLD--- */
 /* const pPos = code.indexOf('P');
  const sPos = code.indexOf('S');
  if(pPos>=0){
    result["HMC Part Number - Marker"]="P";
    result["HMC Part Number"]=code.substring(pPos+1,pPos+11)||"[nincs]";
  }else{
    // fallback - Vendor után 10 char
    if(result["Vendor Code"]!=="[nincs]"){
      let i=code.indexOf(result["Vendor Code"]);
      result["HMC Part Number"]=code.substring(i+result["Vendor Code"].length,i+result["Vendor Code"].length+10)||"[nincs]";
    }
  } */
  
  /* --- HMC Part P --- */
const pPos = code.indexOf('P');
const sPos = code.indexOf('S', pPos + 9);   // <-- keresés P UTÁN

if (pPos >= 0) {
  result["HMC Part Number - Marker"] = "P";

 // let end = (sPos > pPos) ? sPos : pPos + 11; 
 // result["HMC Part Number"] = code.substring(pPos + 1, end) || "[nincs]";

  let end = (sPos > pPos) ? sPos : pPos + 1 + 10;
result["HMC Part Number"] = code.substring(pPos , end) || "[nincs]";

} else {
  // fallback - Vendor után 10 char
  if (result["Vendor Code"] !== "[nincs]") {
    let i = code.indexOf(result["Vendor Code"]);
    result["HMC Part Number"] =
      code.substring(i + result["Vendor Code"].length,
                     i + result["Vendor Code"].length + 10) || "[nincs]";
  }
}

  /* --- Sequence S --- */
  const tPos = code.indexOf('T');
  if(sPos>=0){
    result["Sequence Code - Marker"]="S";
    let end = (tPos>sPos)?tPos:code.length;
    let seq=code.substring(sPos+1,end).replace(/[\x1E\x1D]/g,'').trim();
    result["Sequence Code"]=seq||'[nincs]';
  }

  /* --- Traceability T --- */
  if(tPos>=0){
    result["Traceability Code - Marker"]="T";
    let nextC = code.indexOf('C',tPos+1);
    let chunk = (nextC>tPos?code.substring(tPos,nextC):code.substring(tPos));
    chunk = chunk.replace(/[\x1E\x1D]/g,'');
    const dat = chunk.slice(1);

    if(dat.length>=6) result["Traceability Code - Date (YYMMDD)"]=dat.slice(0,6);
    if(dat.length>=10) result["Traceability Code - Plant Info"]=dat.slice(6,10);

    let rest=dat.slice(10);
    if(rest.startsWith("@")){
      result["Traceability Code Harman P/N Marker"]="@";
      result["Traceability Code Harman P/N"]=rest.slice(1)||"[nincs]";
    }else if(rest.length){
      result["Traceability Code Harman P/N"]=rest;
    }
  }

  /* --- Supplier C --- */
  const cField = findField('C');
  const cPos = code.indexOf('C');
  if(cField){
    result["Supplier's Area - Marker"]="C";
    result["Supplier's Area"]=cField.slice(1,4)||"[nincs]";
  }else if(cPos>=0){
    result["Supplier's Area - Marker"]="C";
    result["Supplier's Area"]=code.substring(cPos+1,cPos+4)||"[nincs]";
  }

  return result;
}

/* -------------------- render ---------------------- */
function renderResult(obj){
  if(obj === "HIBA") {
    document.getElementById('err').innerText = "HIBÁS KÓD!";
    document.getElementById('out').innerHTML = '';
    return;
  }
  document.getElementById('err').innerText = '';

  let html = '<table>';
  const keys = [
    "Header",
    "Vendor Code - Marker",
    "Vendor Code",
    "HMC Part Number - Marker",
    "HMC Part Number",
    "Sequence Code - Marker",
    "Sequence Code",
    "Traceability Code - Marker",
    "Traceability Code - Date (YYMMDD)",
    "Traceability Code - Plant Info",
    "Traceability Code Harman P/N Marker",
    "Traceability Code Harman P/N",
    "Supplier's Area - Marker",
    "Supplier's Area"
  ];
  for(const k of keys){
    const v = obj[k] !== undefined ? obj[k] : '[nincs]';
    html += `<tr><th>${k}</th><td>${fmtVal(v)}</td></tr>`;
  }
  html += '</table>';
  document.getElementById('out').innerHTML = html;
}

/* -------------------- beep ----------------------- */
function beepShort(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 1000;
    o.connect(g);
    g.connect(ctx.destination);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.16);
    setTimeout(()=>{ o.stop(); ctx.close(); }, 200);
  }catch(e){}
}

/* -------------------- Camera ---------------------- */
let codeReader = null;
const videoElem = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');

function resetAll(){
  document.getElementById('out').innerHTML = '';
  document.getElementById('err').innerText = '';
  videoElem.style.display = 'none';
  if(codeReader) {
    try { codeReader.reset(); } catch(e){}
  }
  startBtn.style.display = '';
  stopBtn.style.display = 'none';
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);

function stopCamera(){
  if(codeReader){
    try{ codeReader.reset(); }catch(e){}
  }
  videoElem.style.display = 'none';
  startBtn.style.display = '';
  stopBtn.style.display = 'none';
}

function startCamera(){
  resetAll();
  videoElem.style.display = 'block';
  startBtn.style.display = 'none';
  stopBtn.style.display = '';

  if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

  codeReader.decodeFromVideoDevice(null, videoElem, (result, err) => {
    if(result){
      const text = result.text || '';
      const parsed = HKMC_Barcode_Content(text);
      renderResult(parsed);

      beepShort();
      if(navigator.vibrate) navigator.vibrate(180);

      try{ codeReader.reset(); }catch(e){}
      videoElem.style.display = 'none';
      startBtn.style.display = '';
      stopBtn.style.display = 'none';
    }
  }).catch(e=>{
    document.getElementById('err').innerText = "Kamera hiba: " + (e?.message||e);
    startBtn.style.display = '';
    stopBtn.style.display = 'none';
    try{ if(codeReader) codeReader.reset(); }catch(e){}
    videoElem.style.display = 'none';
  });
}
</script>
</body>
</html>
